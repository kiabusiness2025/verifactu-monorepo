options:
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: ALLOW_LOOSE
substitutions:
  _REGION: europe-west1
  _REPO: verifactu-dev

steps:
# --- API ---
- id: "API: build"
  name: gcr.io/cloud-builders/docker
  entrypoint: bash
  args:
    - -lc
    - |
      if [ "$$(/workspace/scripts/check-changes.sh api)" == "true" ]; then
        IMAGE="$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/verifactu-backend:$SHORT_SHA"
        docker build -t "$$IMAGE" ./api
        docker push "$$IMAGE"
        echo "$$IMAGE" > /workspace/api_image.txt
      else
        echo "NO_CHANGES" > /workspace/api_image.txt
      fi

- id: "API: deploy"
  name: gcr.io/google.com/cloudsdktool/cloud-sdk
  entrypoint: bash
  args:
    - -lc
    - |
      IMG=$$(cat /workspace/api_image.txt)
      if [ "$$IMG" != "NO_CHANGES" ]; then
        gcloud run deploy verifactu-backend-dev \
          --image "$$IMG" \
          --region "$_REGION" \
          --platform managed \
          --port 8080 \
          --allow-unauthenticated \
          --set-env-vars "NODE_ENV=development"
      else
        echo "API: sin cambios, no despliega."
      fi

# --- APP ---
- id: "APP: build"
  name: gcr.io/cloud-builders/docker
  entrypoint: bash
  args:
    - -lc
    - |
      if [ "$$(/workspace/scripts/check-changes.sh app)" == "true" ]; then
        IMAGE="$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/verifactu-app:$SHORT_SHA"
        docker build -t "$$IMAGE" ./app
        docker push "$$IMAGE"
        echo "$$IMAGE" > /workspace/app_image.txt
      else
        echo "NO_CHANGES" > /workspace/app_image.txt
      fi

- id: "APP: deploy"
  name: gcr.io/google.com/cloudsdktool/cloud-sdk
  entrypoint: bash
  args:
    - -lc
    - |
      IMG=$$(cat /workspace/app_image.txt)
      if [ "$$IMG" != "NO_CHANGES" ]; then
        gcloud run deploy verifactu-app-dev \
          --image "$$IMG" \
          --region "$_REGION" \
          --platform managed \
          --port 8080 \
          --allow-unauthenticated \
          --set-env-vars "NEXT_PUBLIC_API_BASE=https://api.dev.verifactu.business"
      else
        echo "APP: sin cambios, no despliega."
      fi

# --- LANDING ---
- id: "LANDING: build"
  name: gcr.io/cloud-builders/docker
  entrypoint: bash
  args:
    - -lc
    - |
      if [ "$$(/workspace/scripts/check-changes.sh landing)" == "true" ]; then
        IMAGE="$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/verifactu-landing:$SHORT_SHA"
        docker build -t "$$IMAGE" ./landing
        docker push "$$IMAGE"
        echo "$$IMAGE" > /workspace/landing_image.txt
      else
        echo "NO_CHANGES" > /workspace/landing_image.txt
      fi

- id: "LANDING: deploy"
  name: gcr.io/google.com/cloudsdktool/cloud-sdk
  entrypoint: bash
  args:
    - -lc
    - |
      IMG=$$(cat /workspace/landing_image.txt)
      if [ "$$IMG" != "NO_CHANGES" ]; then
        gcloud run deploy verifactu-landing-dev \
          --image "$$IMG" \
          --region "$_REGION" \
          --platform managed \
          --port 8080 \
          --allow-unauthenticated
      else
        echo "LANDING: sin cambios, no despliega."
      fi
