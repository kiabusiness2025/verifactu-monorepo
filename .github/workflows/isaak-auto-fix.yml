name: ğŸ¤– Isaak Auto-Fix Build Failures

on:
  # Trigger 1: Cuando hay un push (verifica si hubo fallos previos)
  push:
    branches:
      - main
    paths:
      - 'apps/app/**'
      - 'apps/landing/**'
      - 'packages/**'

  # Trigger 2: Manualmente desde la UI
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Ejecutar auto-fix'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  check-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect common errors in code
        id: detect
        run: |
          ERRORS=""
          
          # ============================================
          # IMPORT ERRORS
          # ============================================
          
          # Error 1: @/lib/auth (doesn't exist)
          if grep -r "from '@/lib/auth'" apps/ 2>/dev/null; then
            ERRORS="${ERRORS}AUTH_IMPORT "
            echo "âŒ Error 1: @/lib/auth imports (use @/lib/session)"
          fi
          
          # Error 2: Named { prisma } import (should be default export)
          if grep -r "import { prisma }" apps/ 2>/dev/null; then
            ERRORS="${ERRORS}PRISMA_IMPORT "
            echo "âŒ Error 2: Named prisma imports (use default import)"
          fi
          
          # Error 3: @/lib/firebaseAdmin (deprecated)
          if grep -r "from '@/lib/firebaseAdmin'" apps/ 2>/dev/null; then
            ERRORS="${ERRORS}FIREBASE_IMPORT "
            echo "âŒ Error 3: @/lib/firebaseAdmin imports"
          fi
          
          # ============================================
          # SESSION & AUTHENTICATION ERRORS
          # ============================================
          
          # Error 4: getSession() without Payload
          if grep -r "await getSession()" apps/app/app/api 2>/dev/null | grep -v "getSessionPayload"; then
            ERRORS="${ERRORS}SESSION_CALL "
            echo "âŒ Error 4: getSession() calls (use getSessionPayload())"
          fi
          
          # Error 5: getSessionPayload(req) with arguments
          if grep -r "getSessionPayload(req)" apps/app/app/api 2>/dev/null; then
            ERRORS="${ERRORS}SESSION_PAYLOAD_ARG "
            echo "âŒ Error 5: getSessionPayload(req) - should be getSessionPayload() no args"
          fi
          
          # Error 6: session.tenant.id (incorrect property)
          if grep -r "session\.tenant\.id" apps/ 2>/dev/null; then
            ERRORS="${ERRORS}SESSION_PROPERTY "
            echo "âŒ Error 6: session.tenant.id (use session.tenantId)"
          fi
          
          # Error 7: Wrong session validation pattern
          if grep -r "session\?\.tenant\?\.id" apps/ 2>/dev/null; then
            ERRORS="${ERRORS}SESSION_VALIDATION "
            echo "âŒ Error 7: Wrong session validation (session?.tenant?.id)"
          fi
          
          # ============================================
          # TYPE GUARD ERRORS (Very common TypeScript issues)
          # ============================================
          
          # Error 8: Type guard missing !session.uid check
          if grep -r "if (!session || !session.tenantId)" apps/app/app/api 2>/dev/null | grep -v "!session.uid"; then
            ERRORS="${ERRORS}INCOMPLETE_TYPE_GUARD "
            echo "âŒ Error 8: Type guard missing !session.uid"
          fi
          
          # Error 9: Type guard missing !session.tenantId or !session.uid
          if grep -r "if (!session\$)" apps/app/app/api 2>/dev/null; then
            if grep -rA 3 "if (!session\$)" apps/app/app/api 2>/dev/null | grep -q "session\.tenantId\|session\.uid"; then
              ERRORS="${ERRORS}INSUFFICIENT_TYPE_GUARD "
              echo "âŒ Error 9: Type guard too simple (only checks !session)"
            fi
          fi
          
          # ============================================
          # SCHEMA & FIELD ERRORS
          # ============================================
          
          # Error 10: dueDate field (doesn't exist in Invoice schema)
          if grep -r "dueDate" apps/app/app/api/invoices 2>/dev/null; then
            ERRORS="${ERRORS}INVOICE_FIELD "
            echo "âŒ Error 10: dueDate field (doesn't exist in Invoice schema)"
          fi
          
          # Error 11: Missing createdBy field in invoice creation
          if grep -r "prisma\.invoice\.create" apps/app/app/api/invoices 2>/dev/null | grep -v "createdBy"; then
            ERRORS="${ERRORS}MISSING_CREATED_BY "
            echo "âŒ Error 11: Missing createdBy in invoice creation"
          fi
          
          # ============================================
          # DECIMAL/NUMBER ARITHMETIC ERRORS
          # ============================================
          
          # Error 12: Direct Decimal arithmetic without .toNumber()
          if grep -r "invoice\.amountNet + invoice\.amountTax" apps/app/app/api 2>/dev/null; then
            ERRORS="${ERRORS}DECIMAL_ARITHMETIC "
            echo "âŒ Error 12: Direct Decimal arithmetic (use .toNumber())"
          fi
          
          # Error 13: Other Decimal operations without conversion
          if grep -r "\.amountNet +\|\.amountTax +\|\.amountGross +" apps/app/app/api 2>/dev/null | grep -v "toNumber"; then
            ERRORS="${ERRORS}DECIMAL_OPERATIONS "
            echo "âŒ Error 13: Decimal operations need .toNumber()"
          fi
          
          # ============================================
          # EMAIL & TEMPLATE ERRORS
          # ============================================
          
          # Error 14: Wrong email template import paths
          if grep -r "from '\.\./emails/'" apps/landing/lib/email 2>/dev/null; then
            ERRORS="${ERRORS}EMAIL_IMPORT "
            echo "âŒ Error 14: Email template paths (use ../../emails/)"
          fi
          
          if [ -z "$ERRORS" ]; then
            echo "âœ… No errors detected"
            echo "has_errors=false" >> $GITHUB_OUTPUT
          else
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”§ Apply auto-fixes
        if: steps.detect.outputs.has_errors == 'true'
        run: |
          echo "ğŸ”§ Applying auto-fixes..."
          
          # Fix 1: @/lib/auth â†’ @/lib/session
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "AUTH_IMPORT"; then
            echo "Fixing AUTH imports..."
            find apps -name "*.ts" -type f -exec sed -i "s/from '@\/lib\/auth'/from '@\/lib\/session'/g" {} +
            find apps -name "*.ts" -type f -exec sed -i "s/import { getSession }/import { getSessionPayload }/g" {} +
          fi
          
          # Fix 2: Named prisma import â†’ default
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "PRISMA_IMPORT"; then
            echo "Fixing Prisma imports..."
            find apps -name "*.ts" -type f -exec sed -i "s/import { prisma }/import prisma/g" {} +
          fi
          
          # Fix 3: @/lib/firebaseAdmin â†’ remove
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "FIREBASE_IMPORT"; then
            echo "Fixing Firebase Admin imports..."
            find apps -name "*.ts" -type f -exec sed -i "s/import { initFirebaseAdmin } from '@\/lib\/firebaseAdmin';//g" {} +
            find apps -name "*.ts" -type f -exec sed -i "s/initFirebaseAdmin();//g" {} +
          fi
          
          # Fix 4: getSession() â†’ getSessionPayload()
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "SESSION_CALL"; then
            echo "Fixing getSession calls..."
            find apps/app/app/api -name "*.ts" -type f -exec sed -i "s/await getSession()/await getSessionPayload()/g" {} +
          fi
          
          # Fix 5: session.tenant.id â†’ session.tenantId
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "SESSION_PROPERTY"; then
            echo "Fixing session property access..."
            find apps -name "*.ts" -type f -exec sed -i "s/session\.tenant\.id/session.tenantId/g" {} +
          fi
          
          # Fix 6: Wrong session validation
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "SESSION_VALIDATION"; then
            echo "Fixing session validation..."
            find apps/app/app/api -name "*.ts" -type f -exec sed -i "s/if (!session\?\.user\?\.id || !session\?\.tenant\?\.id)/if (!session || !session.tenantId)/g" {} +
          fi
          
          # Fix 7: dueDate field
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "INVOICE_FIELD"; then
            echo "Fixing invoice fields..."
            find apps/app/app/api/invoices -name "*.ts" -type f -exec sed -i "/dueDate: new Date(data.dueDate),/d" {} +
          fi
          
          # Fix 8: Incomplete type guard (aÃ±adir !session.uid)
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "INCOMPLETE_TYPE_GUARD"; then
            echo "Fixing incomplete type guards..."
            find apps/app/app/api -name "*.ts" -type f -exec sed -i "s/if (!session || !session\.tenantId)/if (!session || !session.tenantId || !session.uid)/g" {} +
          fi
          
          # Fix 9: Decimal arithmetic (convertir a number antes de sumar)
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "DECIMAL_ARITHMETIC"; then
            echo "Fixing Decimal arithmetic..."
            # Este fix es mÃ¡s complejo, solo lo podemos hacer en el contexto especÃ­fico
            # Buscar el patrÃ³n exacto y reemplazar con la conversiÃ³n correcta
            find apps/app/app/api -name "*.ts" -type f -exec sed -i "s/amountGross: invoice\.amountNet + invoice\.amountTax,/amountGross: (typeof invoice.amountNet === 'number' ? invoice.amountNet : invoice.amountNet.toNumber()) + (typeof invoice.amountTax === 'number' ? invoice.amountTax : invoice.amountTax.toNumber()),/g" {} +
          fi
          
          # Fix 10: getSessionPayload(req) â†’ getSessionPayload()
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "SESSION_PAYLOAD_ARG"; then
            echo "Fixing getSessionPayload calls..."
            find apps/app/app/api -name "*.ts" -type f -exec sed -i "s/getSessionPayload(req)/getSessionPayload()/g" {} +
          fi
          
          # Fix 11: Type guard missing !session.tenantId or !session.uid
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "INSUFFICIENT_TYPE_GUARD"; then
            echo "Fixing insufficient type guards..."
            # This is a more complex fix - we need to add the missing checks
            find apps/app/app/api -name "*.ts" -type f -exec sed -i "s/if (!session)/if (!session || !session.tenantId || !session.uid)/g" {} +
          fi
          
          # Fix 12: Missing createdBy in invoice creation
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "MISSING_CREATED_BY"; then
            echo "Fixing missing createdBy fields..."
            find apps/app/app/api/invoices -name "*.ts" -type f -exec sed -i "s/data: {/data: { createdBy: session.uid,/g" {} +
          fi
          
          # Fix 13: Email template import paths
          if echo "${{ steps.detect.outputs.errors }}" | grep -q "EMAIL_IMPORT"; then
            echo "Fixing email template imports..."
            find apps/landing/lib/email -name "*.ts" -type f -exec sed -i "s/from '\.\.\\/emails\\//from '..\/..\/emails\//g" {} +
          fi
          
          echo "âœ… Auto-fixes applied"

      - name: ğŸ“Š Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes needed"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --name-only
          fi

      - name: ğŸ“ Commit auto-fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "isaak-bot@verifactu.dev"
          git config --local user.name "Isaak Auto-Fixer Bot"
          
          git add -A
          
          COMMIT_MSG="fix(auto): apply automatic code fixes

Fixed issues:
$(git diff --cached --name-only | sed 's/^/- /')

Auto-fixed by Isaak Bot
Detected and resolved:
- Import path issues
- Session handling inconsistencies
- Prisma schema mismatches
- Type guard validations"
          
          git commit -m "$COMMIT_MSG"

      - name: ğŸš€ Push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin main

      - name: âœ… Summary
        run: |
          if [ "${{ steps.detect.outputs.has_errors }}" = "true" ]; then
            echo "ğŸ¤– Isaak Auto-Fix Summary"
            echo "=========================="
            echo "Errors found: ${{ steps.detect.outputs.errors }}"
            if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
              echo "Status: âœ… Fixed and committed"
            else
              echo "Status: âš ï¸ Detected but couldn't auto-fix"
            fi
          else
            echo "âœ… All checks passed, no fixes needed"
          fi
