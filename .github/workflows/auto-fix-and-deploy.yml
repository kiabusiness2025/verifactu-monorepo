name: Auto-Fix & Deploy

on:
  workflow_dispatch:
    inputs:
      error_context:
        description: 'Error context from monitoring'
        required: false
        type: string
      auto_fix:
        description: 'Enable automatic fixes'
        required: false
        type: boolean
        default: true
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '22.x'
  PNPM_VERSION: '9.15.4'

jobs:
  detect-and-fix:
    name: Detect & Auto-Fix Errors
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --node-linker=isolated

      - name: Analyze error context from Isaak
        if: github.event.inputs.error_context != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¤– Isaak Error Analysis"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "${{ github.event.inputs.error_context }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Guardar contexto para anÃ¡lisis
          echo '${{ github.event.inputs.error_context }}' > error-context.json

      - name: Generate Prisma Client
        run: |
          cd apps/app
          pnpm exec prisma generate

      - name: TypeScript Type Check (App)
        id: typecheck-app
        continue-on-error: true
        run: |
          cd apps/app
          pnpm exec tsc --noEmit > typecheck-errors.log 2>&1 || true
          cat typecheck-errors.log

      - name: TypeScript Type Check (Landing)
        id: typecheck-landing
        continue-on-error: true
        run: |
          cd apps/landing
          pnpm exec tsc --noEmit > typecheck-errors.log 2>&1 || true
          cat typecheck-errors.log

      - name: ESLint Check
        id: eslint
        continue-on-error: true
        run: |
          pnpm exec eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 0 || true

      - name: Install GitHub CLI Copilot Extension
        if: steps.typecheck-app.outcome == 'failure' || steps.typecheck-landing.outcome == 'failure'
        run: |
          gh extension install github/gh-copilot || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-Fix TypeScript Errors (App)
        if: steps.typecheck-app.outcome == 'failure'
        run: |
          cd apps/app
          if [ -f typecheck-errors.log ]; then
            echo "Analyzing errors with Copilot..."
            # Extraer errores mÃ¡s comunes
            node ../../scripts/auto-fix-typescript.js typecheck-errors.log
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-Fix TypeScript Errors (Landing)
        if: steps.typecheck-landing.outcome == 'failure'
        run: |
          cd apps/landing
          if [ -f typecheck-errors.log ]; then
            echo "Analyzing errors with Copilot..."
            node ../../scripts/auto-fix-typescript.js typecheck-errors.log
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit Auto-Fixes
        if: steps.typecheck-app.outcome == 'failure' || steps.typecheck-landing.outcome == 'failure'
        run: |
          git config --local user.email "isaak@verifactu.business"
          git config --local user.name "Isaak Auto-Fix Bot"
          git add -A
          git diff --staged --quiet || git commit -m "ğŸ¤– Isaak: Auto-fix errors

          Triggered by: ${{ github.event_name }}
          ${{ github.event.inputs.error_context != '' && format('Context: {0}', github.event.inputs.error_context) || '' }}

          [skip ci]"
          git push

      - name: Re-run Type Check (App)
        if: steps.typecheck-app.outcome == 'failure'
        run: |
          cd apps/app
          pnpm exec tsc --noEmit

      - name: Re-run Type Check (Landing)
        if: steps.typecheck-landing.outcome == 'failure'
        run: |
          cd apps/landing
          pnpm exec tsc --noEmit

      - name: Build App
        run: |
          cd apps/app
          pnpm run build

      - name: Build Landing
        run: |
          cd apps/landing
          pnpm run build

      - name: Report Success Status
        if: success()
        run: |
          echo "âœ… All checks passed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ TypeScript checks: PASSED"
          echo "âœ“ App build: PASSED"
          echo "âœ“ Landing build: PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Ready for deployment to Production"

  # deploy-vercel:
  #   Vercel deploys automatically via GitHub App integration
  #   This workflow only validates code quality

  deploy-cloud-run:
    name: Deploy API to Cloud Run
    needs: [detect-and-fix]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and Deploy to Cloud Run
        run: |
          gcloud builds submit \
            --config cloudbuild-backend.yaml \
            --substitutions=SHORT_SHA=${GITHUB_SHA::7},BRANCH_NAME=main
